<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>サポートフォーム</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .section { display: none; margin-top: 20px; }
    .visible { display: block; }
    label { display: block; margin-top: 10px; }
    select, input, textarea { width: 100%; padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>サポートフォーム</h2>

  <label for="mode">モードを選択：</label>
  <select id="mode">
    <option value="予約">サポートMTG予約</option>
    <option value="相談">相談依頼</option>
  </select>

  <!-- 予約 -->
  <div id="予約" class="section visible">
    <label>予約希望日時：</label>
    <div id="reserveList">
      <input type="datetime-local" class="reserveDate" />
    </div>
    <button type="button" onclick="addReserve()">＋追加</button>
  </div>

  <!-- 相談依頼 -->
  <div id="相談" class="section">
    <label>相談内容の種類：</label>
    <select id="consultType">
      <option value="">選択してください</option>
      <option value="リッチメニュー">リッチメニュー</option>
      <option value="クーポン">クーポン</option>
      <option value="メニュー追加・変更">メニュー追加・変更</option>
      <option value="その他">その他</option>
      <option value="配信代行依頼">配信代行依頼</option>
    </select>

    <!-- リッチメニュー -->
    <div id="リッチメニュー" class="section">
      <label>目的：</label>
      <select id="rmPurpose">
        <option value="新規作成">新規作成</option>
        <option value="デザイン変更（ボタン追加）">デザイン変更（ボタン追加）</option>
        <option value="デザイン変更（ボタン変更）">デザイン変更（ボタン変更）</option>
      </select>
      <label>内容：</label>
      <textarea id="rmDetail"></textarea>
    </div>

    <!-- クーポン -->
    <div id="クーポン" class="section">
      <label>画像アップロード：</label>
      <input type="file" id="couponImage" />
      <label>クーポンの種類：</label>
      <input type="text" id="couponKind" />
      <label>クーポン名：</label>
      <input type="text" id="couponName" />
      <label>有効期間：</label>
      <input type="text" id="couponPeriod" placeholder="例：2025年1月1日～2025年2月1日" />
      <label>利用ガイド：</label>
      <textarea id="couponGuide"></textarea>
      <label>利用可能数：</label>
      <select id="couponCount">
        <option value="1回のみ">1回のみ</option>
        <option value="無制限">無制限</option>
      </select>
      <label>利用方法：</label>
      <textarea id="couponUse"></textarea>
    </div>

    <!-- メニュー -->
    <div id="メニュー追加・変更" class="section">
      <label>操作：</label>
      <select id="menuAction">
        <option value="追加">追加</option>
        <option value="変更">変更</option>
        <option value="削除">削除</option>
      </select>
      <label>内容：</label>
      <textarea id="menuDetail"></textarea>
    </div>

    <!-- その他 -->
    <div id="その他" class="section">
      <label>内容：</label>
      <textarea id="otherDetail"></textarea>
    </div>

    <!-- 配信代行依頼 -->
    <div id="配信代行依頼" class="section">
      <label>配信日時：</label>
      <input type="datetime-local" id="sendDatetime" />
      <label>配信内容：</label>
      <textarea id="sendContent"></textarea>
      <label>備考：</label>
      <textarea id="sendNote"></textarea>
    </div>
  </div>

  <button onclick="submitForm()">送信</button>

  <script>
    const modeSelect = document.getElementById("mode");
    const consultType = document.getElementById("consultType");

    modeSelect.addEventListener("change", () => {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("visible"));
      document.getElementById(modeSelect.value).classList.add("visible");
    });

    consultType.addEventListener("change", () => {
      document.querySelectorAll("#相談 .section").forEach(s => s.classList.remove("visible"));
      const selected = consultType.value;
      if (selected) {
        document.getElementById(selected).classList.add("visible");
      }
    });

    async function submitForm() {
      await liff.init({ liffId: "2007228552-OdkKEe6Y" });
      const profile = await liff.getProfile();

      const data = {
        name: profile.displayName,
        type: modeSelect.value === "予約" ? "サポートMTG予約" : consultType.value,
      };

      if (modeSelect.value === "予約") {
        const reserveInputs = document.querySelectorAll(".reserveDate");
        data.dates = Array.from(reserveInputs).map(input => input.value).filter(v => v);
      } else {
        const type = consultType.value;
        if (type === "リッチメニュー") {
          data.purpose = document.getElementById("rmPurpose").value;
          data.detail = document.getElementById("rmDetail").value;
        } else if (type === "クーポン") {
          data.kind = document.getElementById("couponKind").value;
          data.name = document.getElementById("couponName").value;
          data.period = document.getElementById("couponPeriod").value;
          data.guide = document.getElementById("couponGuide").value;
          data.count = document.getElementById("couponCount").value;
          data.use = document.getElementById("couponUse").value;
          // 画像はここで処理が必要（後述）
        } else if (type === "メニュー追加・変更") {
          data.action = document.getElementById("menuAction").value;
          data.detail = document.getElementById("menuDetail").value;
        } else if (type === "その他") {
          data.detail = document.getElementById("otherDetail").value;
        } else if (type === "配信代行依頼") {
          data.datetime = document.getElementById("sendDatetime").value;
          data.content = document.getElementById("sendContent").value;
          data.note = document.getElementById("sendNote").value;
        }
      }

      fetch("https://script.google.com/macros/s/AKfycbyAD7PrDNDZl5Plx89ybgpsFs7TgCL9sjzgH6KYheN55sPYCxJ_SnyLI2zfzxtaTwTOwg/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"  // ← これがないと e.postData が来ない
        },
        body: JSON.stringify(data),
        mode: "no-cors"
      });


      alert("送信しました！");
    }

    function addReserve() {
      const container = document.getElementById("reserveList");
      const count = container.querySelectorAll(".reserveDate").length;
      if (count >= 5) {
        alert("最大5件まで登録できます");
        return;
      }
      const input = document.createElement("input");
      input.type = "datetime-local";
      input.className = "reserveDate";
      container.appendChild(input);
    }
  </script>
</body>
</html>
